# Copyright (c) 2020, 2021, Oracle and/or its affiliates.
# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.

  {{- if .Values.console.enabled }}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: {{ .Values.console.name }}
  name: {{ .Values.console.name }}
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: {{ .Values.console.name }}
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
    type: RollingUpdate
  template:
    metadata:
      annotations:
        sidecar.istio.io/inject: "true"
      labels:
        app: {{ .Values.console.name }}
    spec:
      containers:
      - image: {{ .Values.console.imageName }}:{{ .Values.console.imageVersion }}
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        name: {{ .Values.console.name }}
        ports:
            - containerPort: 8000
        env:
          - name: VZ_UI_URL
            value: "https://verrazzano.{{ .Values.config.envName }}.{{ .Values.config.dnsSuffix }}"
          - name: VZ_API_URL
            value: "https://verrazzano.{{ .Values.config.envName }}.{{ .Values.config.dnsSuffix }}"
          - name: VZ_KEYCLOAK_URL
            value: "https://keycloak.{{ .Values.config.envName }}.{{ .Values.config.dnsSuffix }}"
          - name: VZ_CLIENT_ID
            value: verrazzano-pkce
      serviceAccount: {{ .Values.console.name }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ .Values.console.name }}
  namespace: {{ .Release.Namespace }}
spec:
  ports:
  - name: console
    port: 8000
    protocol: TCP
    targetPort: 8000
  selector:
    app: {{ .Values.console.name }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ .Values.console.name }}
  namespace: {{ .Release.Namespace }}
{{- if .Values.global.imagePullSecrets }}
imagePullSecrets:
{{- range .Values.global.imagePullSecrets }}
- name: {{ . }}
{{- end }}
{{- end }}
# Copyright (c) 2021, Oracle and/or its affiliates.
# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.

---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    {{- if .Values.dns.wildcard.domain}}
    verrazzano.io/dns.wildcard.domain: {{ .Values.dns.wildcard.domain }}
    {{- end }}
    external-dns.alpha.kubernetes.io/target: verrazzano-console.{{ .Values.config.envName }}.{{ .Values.config.dnsSuffix }}
    kubernetes.io/tls-acme: "true"
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    nginx.ingress.kubernetes.io/affinity: cookie
    nginx.ingress.kubernetes.io/configuration-snippet: |
      proxy_hide_header X-Powered-By;
      add_header Last-Modified "$date_gmt";
      add_header Pragma "no-cache";
      add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
      add_header Expect-CT "max-age=86400, enforce";
      add_header Referrer-Policy "strict-origin";
      add_header X-Content-Type-Options "nosniff" always;
      add_header X-Frame-Options "DENY" always;
      add_header X-Permitted-Cross-Domain-Policies "none";
      add_header Strict-Transport-Security "max-age=86400; includeSubDomains";
      add_header X-XSS-Protection "1; mode=block";
      add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-eval' static.oracle.com; form-action 'none'; connect-src 'self' https:; media-src 'none'; object-src 'none'; font-src 'self' static.oracle.com; img-src 'self' data:; style-src 'self' static.oracle.com; frame-ancestors 'none';" always;
    nginx.ingress.kubernetes.io/session-cookie-conditional-samesite-none: "true"
    nginx.ingress.kubernetes.io/session-cookie-expires: "86400"
    nginx.ingress.kubernetes.io/session-cookie-max-age: "86400"
    nginx.ingress.kubernetes.io/session-cookie-name: route
    nginx.ingress.kubernetes.io/session-cookie-samesite: Strict
    nginx.ingress.kubernetes.io/service-upstream: "true"
    nginx.ingress.kubernetes.io/upstream-vhost: "${service_name}.${namespace}.svc.cluster.local"
  name: verrazzano-console
  namespace: {{ .Release.Namespace }}
spec:
  rules:
    - host: verrazzano-console.{{ .Values.config.envName }}.{{ .Values.config.dnsSuffix }}
      http:
        paths:
          - backend:
              serviceName: {{ .Values.console.name }}
              servicePort: 8000
            path: /()(.*)
  tls:
    - hosts:
        - verrazzano-console.{{ .Values.config.envName }}.{{ .Values.config.dnsSuffix }}
      secretName: {{ .Values.config.envName }}-secret

  {{- end }}
