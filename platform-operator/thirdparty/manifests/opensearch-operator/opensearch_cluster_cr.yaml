# Copyright (c) 2023, Oracle and/or its affiliates.
# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.

{{- if .isOpenSearchEnabled }}
apiVersion: opensearch.opster.io/v1
kind: OpenSearchCluster
metadata:
  name: opensearch
  namespace: verrazzano-logging
spec:
  {{- if .bootstrapConfig }}
  bootstrap:
    additionalConfig:
      {{ .bootstrapConfig }}
  {{- end }}
  initHelper:
    image: {{ .initImage }}
  dashboards:
    additionalConfig:
      opensearch.requestHeadersAllowlist: '["securitytenant","Authorization","x-forwarded-for","X-WEBAUTH-USER","x-proxy-roles"]'
      opensearch_security.auth.type: proxy
      opensearch_security.multitenancy.enabled: "false"
      opensearch_security.proxycache.roles_header: x-proxy-roles
      opensearch_security.proxycache.user_header: X-WEBAUTH-USER
      server.name: opensearch-dashboards
    enable: {{ .isOpenSearchDashboardsEnabled }}
    image: {{ .osdImage }}
    {{- if .osdPluginsEnabled }}
    pluginsList:
{{ multiLineIndent 6 .osdPluginsList }}
    {{- end }}
    opensearchCredentialsSecret:
      name: admin-credentials-secret
    replicas: {{ .osdReplicas }}
    tls:
      enable: true
      generate: false
      secret:
        name: opensearch-dashboards-cert
    version: 2.3.0
    podSecurityContext:
      fsGroup: 1000
      runAsGroup: 1000
      runAsNonRoot: true
      runAsUser: 1000
      seccompProfile:
        type: RuntimeDefault
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
          - ALL
  general:
    drainDataNodes: {{ .drainDataNodes }}
    httpPort: 9200
    image: {{ .opensearchImage }}
    serviceName: opensearch
    serviceAccount: opensearch-operator-controller-manager
    setVMMaxMapCount: true
    vendor: opensearch
    version: 2.3.0
    podSecurityContext:
      seccompProfile:
        type: RuntimeDefault
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
          - ALL
      privileged: false
      runAsUser: 1000
    {{- if .osPluginsEnabled }}
    pluginsList:
{{ multiLineIndent 6 .osPluginsList }}
    {{- end }}
  nodePools:
{{ multiLineIndent 4 .nodePools }}
  security:
    config:
      adminCredentialsSecret:
        name: admin-credentials-secret
      securityConfigSecret:
        name: securityconfig-secret
      adminSecret:
        name: opensearch-admin-cert
    tls:
      transport:
        generate: false
        secret:
          name: opensearch-node-cert
        adminDn: [ "CN=admin,O=verrazzano" ]
        nodesDn: [ "CN=opensearch,O=verrazzano" ]
      http:
        generate: false
        secret:
          name: opensearch-master-cert
{{- end }}