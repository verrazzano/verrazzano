[![Go Report Card](https://goreportcard.com/badge/github.com/verrazzano/verrazzano)](https://goreportcard.com/report/github.com/verrazzano/verrazzano)

# verrazzano-platform-operator

This document contains instructions for building and testing the verrazzano-platform-operator.

## Prerequisites
* kustomize v3.1.0+
* kubebuilder 2.3.1+
* go version v1.13+
* docker
* kubectl

## Performing a build and Verrazzano install

To build and then install Verrazzano with the verrazzano-platform-operator follow these steps.

```
# Create the verrazzano-platform-operator image.  For now, the image needs public access.
# Replace <docker-repository> and <namespace for image>.
export DOCKER_REPO=<docker-repository>
export DOCKER_NAMESPACE=<namespace for image>
make docker-push

# Create the verrrazzano-platform-operator deployment yaml file.
# Define the VZ_DEV_IMAGE env variable and call the create-test-deploy target
# - Replace <verrazzano-image> with the verrazzano-platform-operator image you created with 'make docker-push'
# - creates a valid deployment yaml file in /tmp/operator.yaml
export VZ_DEV_IMAGE=<verrazzano-image>
make create-test-deploy

# Deploy the verrazzano-platform-operator
kubectl apply -f /tmp/operator.yaml

# Verify verrazzano-platform-operator pod is running
kubectl get pods -n verrazzano-install

# Initiate a Verrazzano install for xip.io
kubectl apply -f config/samples/install-default.yaml

# NOTE:  If you chose to deploy a cluster that makes use of OCI DNS perform the following instead of the xip.io
# cluster deployment command:

# generate a secret named "oci" based on the OCI configuration profile you wish to leverage.  You
# can specify a profile other than DEFAULT and a different secret name if you wish.  See instruction by executing
# ./scripts/install/create_oci_config_secret.sh
./scripts/install/create_oci_config_secret.sh

# copy the config/samples/install-oci.yaml file
cp config/samples/install-oci.yaml /tmp

# edit the file and provide the DNS ZONE name, OCID, and compartment OCID, and secret name

# Monitor the install
kubectl logs -f $(kubectl get pod -l job-name=verrazzano-install-my-verrazzano -o jsonpath="{.items[0].metadata.name}")

# Wait for the Verrazzano install to complete
kubectl wait --timeout=20m --for=condition=InstallComplete verrazzano/my-verrazzano
```

To uninstall Verrazzano with the verrazzano-platform-operator follow these steps.

```
# Initiate a Verrazzano uninstall
kubectl delete -f config/samples/install-default.yaml

# Monitor the uninstall
kubectl logs -f $(kubectl get pod -l job-name=verrazzano-uninstall-my-verrazzano -o jsonpath="{.items[0].metadata.name}")
```

## Building the Operator

* To make a change to `deploy/operator.yaml`

    Do not edit the file `deploy/operator.yaml` because it is generated by concatenating the following files:
    - `config/deploy/verrazzano-platform-operator.yaml` - this file contains definitions for the `Namespace`, `ServiceAccount`, `ClusterRoleBinding` and `Deployment` objects.
    - `config/crd/bases/install.verrazzano.io_verrazzanos.yaml` - this file contains the yaml to define the custom resource named `verrazzano`.
    
   To update the `deploy/operator.yaml` file do the following:
   - Make changes to `config/deploy/verrazzano-platform-operator.yaml'
   - Make changes to `api/v1alpha1/verrazzano_types.go`
   - Execute `make manifests`

* To generate manifests (e.g. deploy/operator.yaml, CRD, RBAC etc.)
    ```
    make manifests
    ```

* To generate code (e.g. zz_generated.deepcopy.go)
    ```
    make generate
    ```

* To do all the source code checks, such as fmt, lint, etc
    ```
    make check
    ```
  
* To build the operator and generated code 
    ```
    make go-install
    ```
    
## Testing out the Operator

Youâ€™ll need a Kubernetes cluster to run against.

* Install the CRDs into the cluster:
    ```
    make install-crds
    ```

* Run the operator (this will run in the foreground, so switch to a new terminal if you want to leave it running):
    ```
    make run
    ```

* Create a custom resource.  You will notice that messages are logged to the operator
when the custom resource is applied. 
    ```
    kubectl apply -f config/samples/install-default.yaml
    ```

* Delete the custom resource.  You will notice that messages are logged to the operator
when the custom resource is deleted.
    ```
    kubectl delete -f config/samples/install-default.yaml
    ```
* Uninstall the CRDs from the cluster:
    ```
    make uninstall-crds
    ```

## Building and pushing docker images

* To build the docker image:
    ```
    make docker-build
    ```
* To build and push the docker image:
    ```
    make docker-push
    ```  
  
## Running kind based integration tests
Be careful when running these. You should make sure that KUBECONFIG is not defined, and
also make sure you do not have anything in $HOME/.kube/config. That will ensure the tests
are not interacting with another cluster.
```
make build docker-build integ-test
```
