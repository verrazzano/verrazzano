// Copyright (c) 2021, 2022, Oracle and/or its affiliates.
// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.

pipeline {
    options {
        timestamps ()
        copyArtifactPermission('/upload-scan-report')
        // allow all the projects or branches of 'Other-folder/Multi branch Pipeline Test' and 'second Folder' to copy artifacts of this job
    }

    agent {
       docker {
            image "${RUNNER_DOCKER_IMAGE}"
            args "${RUNNER_DOCKER_ARGS}"
            label "VM.Standard2.2"
        }
    }

    environment {
        UPLOAD_FILE='consolidated-upload.json'
    }

    stages {
        stage('Create consolidated-upload.json file') {
            steps {
                script {
                    sh """
                        echo "Creating ${UPLOAD_FILE} ..."
                        echo "This is ${UPLOAD_FILE} for build ${env.BRANCH_NAME}/${env.BUILD_NUMBER}" > ${UPLOAD_FILE}
                        echo "Created ${UPLOAD_FILE}"
                        echo "ls -ld ${UPLOAD_FILE}"
                        ls -ld ${UPLOAD_FILE}
                        echo "cat ${UPLOAD_FILE}"
                        cat ${UPLOAD_FILE}
                        echo "JOB_NAME is '${env.JOB_NAME}'"
                        echo "BUILD_NUMBER is '${env.BUILD_NUMBER}'"
                    """
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: "${UPLOAD_FILE}", allowEmptyArchive: true
                }
            }
        }
    }
    post {
        success {
            script {
                build job: 'upload-scan-report', parameters: [
                    string(name: 'UPSTREAM_JOB', value: "${env.JOB_NAME}"),
                    string(name: 'UPSTREAM_BUILD', value: "${env.BUILD_NUMBER}")
                ], propagate: false, wait: false
            }
        }
    }
}
