kubernetes_sd_configs:
- namespaces:
    names:
    - {{.workload.metadata.namespace}}
  role: pod
relabel_configs:
- action: replace
  replacement: local
  source_labels: null
  target_label: verrazzano_cluster
- action: keep
  regex: true;{{.workload.metadata.uid}}
  source_labels:
  - __meta_kubernetes_pod_label_prometheus.io_scrape
  - __meta_kubernetes_pod_label_verrazzano.io_metrics-workload-uid
- action: replace
  regex: (.+)
  source_labels:
  - __meta_kubernetes_pod_label_prometheus.io_path
  target_label: __metrics_path__
- action: replace
  regex: ([^:]+)(?::\d+)?;(\d+)
  replacement: $1:$2
  source_labels:
  - __address__
  - __meta_kubernetes_pod_label_prometheus.io_port
  target_label: __address__
- action: replace
  regex: (.*)
  replacement: $1
  source_labels:
  - __meta_kubernetes_namespace
  target_label: namespace
- action: labelmap
  regex: __meta_kubernetes_pod_label_(.+)
- action: replace
  source_labels:
  - __meta_kubernetes_pod_name
  target_label: pod_name
- action: labeldrop
  regex: (controller_revision_hash)
- action: replace
  regex: .*/(.*)$
  replacement: $1
  source_labels:
  - name
  target_label: webapp
{{if eq (index .namespace.metadata.labels "istio-injection") "enabled"}}
scheme: https
tls_config:
  ca_file: /etc/istio-certs/root-cert.pem
  cert_file: /etc/istio-certs/cert-chain.pem
  insecure_skip_verify: true
  key_file: /etc/istio-certs/key.pem
{{end}}
